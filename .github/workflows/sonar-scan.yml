name: SonarQube Scan

on:
  pull_request:
    branches:
      - main  # Adjust this to the branch you want to scan

jobs:
  sonar_scan:
    name: SonarQube Scan with Docker
    runs-on: macos-latest  # Run on macOS

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        npm install

    # Step 4: Install Docker (macOS)
    - name: Install Docker (macOS)
      run: |
        brew install --cask docker

    # Step 5: Wait for Docker to be ready (this step ensures Docker starts)
    - name: Wait for Docker to start
      run: |
        while ! docker info > /dev/null 2>&1; do
          echo "Waiting for Docker to start..."
          sleep 5
        done

    # Step 6: Pull Docker image with Node.js, Java 17, and SonarQube Scanner
    - name: Pull Docker image
      run: |
        docker pull maven:3.8.1-openjdk-17

    # Step 7: Create Docker container with the pulled image
    - name: Create Docker container
      run: |
        docker run --name sonar-scan-container -d maven:3.8.1-openjdk-17

    # Step 8: Install dependencies inside Docker container
    - name: Install dependencies in Docker container
      run: |
        docker exec sonar-scan-container bash -c "cd /mnt/sonar && npm install"

    # Step 9: Run SonarQube Scan inside Docker container
    - name: Run SonarQube Scan in Docker container
      run: |
        docker exec sonar-scan-container bash -c "sonar-scanner \
          -Dsonar.projectKey=sonarqube-nodejs-project \
          -Dsonar.sources=. \
          -Dsonar.host.url=http://localhost:9000 \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.sourceEncoding=UTF-8"

    # Step 10: Clean up Docker container
    - name: Clean up Docker container
      run: |
        docker stop sonar-scan-container
        docker rm sonar-scan-container
