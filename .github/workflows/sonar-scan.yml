name: SonarQube Scan

on:
  pull_request:
    branches:
      - main  # Adjust this to the branch you want to scan

jobs:
  sonar_scan:
    name: SonarQube Scan
    runs-on: macos-latest  # Run on macOS

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        npm install

    # Step 4: Install Java 17
    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: '17'

    # Step 5: Set JAVA_HOME environment variable
    - name: Set JAVA_HOME
      run: |
        echo "JAVA_HOME=$(dirname $(dirname $(readlink $(which java))))" >> $GITHUB_ENV

    # Step 6: Verify Java version
    - name: Verify Java version
      run: |
        java -version

    # Step 7: Install SonarQube Scanner (macOS)
    - name: Install SonarQube Scanner (macOS)
      run: |
        curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-macosx.zip
        unzip sonar-scanner.zip -d sonar-scanner
        chmod +x sonar-scanner/sonar-scanner-4.6.2.2472-macosx/bin/sonar-scanner

        # Add sonar-scanner to PATH (make sure this is accessible in subsequent steps)
        echo "sonar-scanner/sonar-scanner-4.6.2.2472-macosx/bin" >> $GITHUB_PATH

    # Step 8: Verify SonarQube Scanner Installation
    - name: Verify SonarQube Scanner Installation
      run: |
        echo $PATH  # Check if the sonar-scanner directory is in PATH
        sonar-scanner --version  # Verify sonar-scanner is accessible

    # Step 9: Run SonarQube Scan
    - name: Run SonarQube Scan
      run: |
        sonar-scanner \
          -Dsonar.projectKey=sonarqube-nodejs-project \
          -Dsonar.sources=. \
          -Dsonar.host.url=http://localhost:9000 \
          -Dsonar.login=sqp_a1467b114c4f45dba482674fb1926c6b919f2942 \
          -Dsonar.sourceEncoding=UTF-8