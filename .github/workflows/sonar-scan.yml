name: SonarQube Scan

on:
  pull_request:
    branches:
      - main  # Adjust this to the branch you want to scan

jobs:
  sonar_scan:
    name: SonarQube Scan
    runs-on: macos-latest  # Run on macOS

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        npm install

    # Step 4: Install Java 17
    - name: Install Java 17
      run: |
        brew install openjdk@17
        sudo ln -sfn /usr/local/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
        echo 'export PATH="/usr/local/opt/openjdk@17/bin:$PATH"' >> ~/.zshrc
        echo 'export JAVA_HOME=$(/usr/libexec/java_home -v 17)' >> ~/.zshrc
        source ~/.zshrc

    # Step 5: Install SonarQube Scanner (macOS)
    - name: Install SonarQube Scanner (macOS)
      run: |
        curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-macosx.zip
        unzip sonar-scanner.zip -d sonar-scanner
        chmod +x sonar-scanner/sonar-scanner-4.6.2.2472-macosx/bin/sonar-scanner

        # Add sonar-scanner to PATH (make sure this is accessible in subsequent steps)
        echo "sonar-scanner/sonar-scanner-4.6.2.2472-macosx/bin" >> $GITHUB_PATH

    # Step 6: Verify SonarQube Scanner Installation
    - name: Verify SonarQube Scanner Installation
      run: |
        echo $PATH  # Check if the sonar-scanner directory is in PATH
        sonar-scanner --version  # Verify sonar-scanner is accessible

    # Step 7: Run SonarQube Scan
    - name: Run SonarQube Scan
      run: |
        sonar-scanner \
          -Dsonar.projectKey=sonarqube-nodejs-project \
          -Dsonar.sources=. \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=sqp_a1467b114c4f45dba482674fb1926c6b919f2942